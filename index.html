<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Planning Calculator</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
        }
        .title {
            text-align: center;
            font-size: 2em;
            margin-bottom: 20px;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
        }
        .table-container {
            margin-top: 20px;
        }
        .d-flex.align-items-center {
            justify-content: space-between;
        }
        .form-label {
            white-space: nowrap;
            margin-right: 10px;
        }
        th, td {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Row 1: Site Title -->
        <div class="row title">
            <h1>Sprint Planning Calculator</h1>
        </div>

        <!-- Row 2: Two-column layout for inputs -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="teamVelocity" class="form-label" data-bs-toggle="tooltip" title="Team's average velocity in story points from previous sprints">Team Velocity:</label>
                    <input type="number" class="form-control w-50" id="teamVelocity" value="88" placeholder="Enter team velocity" oninput="calculateTargetStoryPoints()">
                </div>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="sprintStarts" class="form-label" data-bs-toggle="tooltip" title="Start date of the sprint">Sprint Starts:</label>
                    <input type="date" class="form-control w-50" id="sprintStarts">
                </div>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="sprintEnds" class="form-label" data-bs-toggle="tooltip" title="End date of the sprint">Sprint Ends:</label>
                    <input type="date" class="form-control w-50" id="sprintEnds">
                </div>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label class="form-label" data-bs-toggle="tooltip" title="Number of sprint days excluding weekends">Total Days:</label>
                    <span class="form-control w-50" id="sprintDays">0</span>
                </div>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="reservedCapacity" class="form-label" data-bs-toggle="tooltip" title="Percentage of time reserved for non-sprint activities">Reserved Capacity (%):</label>
                    <input type="number" class="form-control w-50" id="reservedCapacity" value="10" oninput="calculateTargetStoryPoints()">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="teamSize" class="form-label" data-bs-toggle="tooltip" title="Total number of team members">Team Size:</label>
                    <span class="form-control w-50" id="teamSize">0</span>
                </div>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="totalTeamDays" class="form-label" data-bs-toggle="tooltip" title="Total available team days during the sprint">Total Team Days:</label>
                    <span class="form-control w-50" id="totalTeamDays">0</span>
                </div>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="totalTeamCapacity" class="form-label" data-bs-toggle="tooltip" title="Team capacity based on available days">Sprint Capacity (%):</label>
                    <span class="form-control w-50" id="totalTeamCapacity">0</span>
                </div>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="targetStoryPoints" class="form-label" data-bs-toggle="tooltip" title="Sprint target story points based on reserved capacity">Sprint Target:</label>
                    <span class="form-control w-50" id="targetStoryPoints">0</span>
                </div>
            </div>
        </div>

        <!-- Row 3: Team Members Table -->
        <div class="row table-container">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Team Member</th>
                        <th>Available Days</th>
                        <th>PTO Dates</th>
                        <th><button class="btn btn-primary" onclick="addTeamMember()">Add</button></th>
                    </tr>
                </thead>
                <tbody id="teamTable">
                </tbody>
            </table>
        </div>

        <!-- Row 4: Site footer -->
        <div class="row footer">
            <h4>Powered By <a href="https://github.com/omaciel/capacitator" target="_blank" rel="noopener" >Capacitator</a></h4>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Bootstrap tooltips initialization
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        window.onload = function() {
            // Set the default values for Sprint Starts and Sprint Ends based on system's current date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sprintStarts').value = today;
            document.getElementById('sprintStarts').setAttribute('min', today);

            // Set Sprint Ends to two weeks from the current date
            const twoWeeksFromNow = new Date();
            twoWeeksFromNow.setDate(twoWeeksFromNow.getDate() + 14);
            const sprintEndsDate = twoWeeksFromNow.toISOString().split('T')[0];
            document.getElementById('sprintEnds').value = sprintEndsDate;
            document.getElementById('sprintEnds').setAttribute('min', today);

            calculateSprintDays();
        };

        // Sprint Ends date should never be before Sprint Starts
        document.getElementById('sprintStarts').addEventListener('change', function() {
            const sprintStartDate = this.value;
            document.getElementById('sprintEnds').setAttribute('min', sprintStartDate);
            calculateSprintDays();
        });

        // Automatically calculate the total number of days in the Sprint
        document.getElementById('sprintEnds').addEventListener('change', function() {
            calculateSprintDays();
        });

        // Add new team member row
        function addTeamMember() {
            const table = document.getElementById('teamTable');
            const newRow = table.insertRow();
            
            // Insert new cells for teammate name, available days, and PTO dates
            const cell1 = newRow.insertCell(0);
            const cell2 = newRow.insertCell(1);
            const cell3 = newRow.insertCell(2);
            
            // Add input fields in the new row
            cell1.innerHTML = '<input type="text" class="form-control" placeholder="Teammate Name">';
            cell2.innerHTML = `<input type="number" class="form-control available-days" value="${document.getElementById('sprintDays').innerText}" oninput="calculateTotalTeamDays()">`;
            cell3.innerHTML = '<input type="text" class="form-control" placeholder="PTO Dates">';

            const cell4 = newRow.insertCell(3);
            cell4.innerHTML = '<button class="btn btn-danger" onclick="deleteTeamMember(this)">Delete</button>';

            // Update team size
            updateTeamSize();

            // Recalculate total team days after adding a new member
            calculateTotalTeamDays();
        }

        // Delete team member from table
        function deleteTeamMember(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            updateTeamSize();
        }

        // Refresh calculations for total team size
        function updateTeamSize() {
            document.getElementById('teamSize').innerText = document.getElementById('teamTable').rows.length;
            calculateTotalTeamDays();
        }

        // Calculate the total number of days for the sprint for all team members
        function calculateTotalTeamDays() {
            const availableDaysInputs = document.getElementsByClassName('available-days');
            let totalDays = 0;
            
            // Loop through all available days inputs and sum up their values
            if (availableDaysInputs.length > 0) {
                for (let i = 0; i < availableDaysInputs.length; i++) {
                    const days = parseFloat(availableDaysInputs[i].value);
                    totalDays += days;
                }
            }
            document.getElementById('totalTeamDays').innerText = totalDays;

            calculateTotalTeamCapacity();
        }

        function calculateTotalTeamCapacity() {
            const totalTeamDays = parseFloat(document.getElementById('totalTeamDays').innerText);
            const teamSize = parseInt(document.getElementById('teamSize').innerText);
            const totalSprintDays = parseInt(document.getElementById('sprintDays').innerText);

            if (teamSize > 0 && totalSprintDays > 0) {
                const totalTeamCapacity = (totalTeamDays / teamSize) * totalSprintDays;
                document.getElementById('totalTeamCapacity').innerText = totalTeamCapacity.toFixed(2);
            } else {
                document.getElementById('totalTeamCapacity').innerText = '0';
            }

            calculateTargetStoryPoints();
        }

        function calculateSprintDays() {
            const sprintStart = new Date(document.getElementById('sprintStarts').value);
            const sprintEnd = new Date(document.getElementById('sprintEnds').value);

            // Calculate the number of working days excluding weekends
            let workingDays = 0;
            let currentDate = new Date(sprintStart);

            while (currentDate <= sprintEnd) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Exclude Saturdays and Sundays
                    workingDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            document.getElementById('sprintDays').innerText = workingDays;

            // Recalculate team capacity based on new sprint days
            calculateTotalTeamCapacity();
        }

        function calculateTargetStoryPoints() {
            const teamVelocity = parseFloat(document.getElementById('teamVelocity').value);
            const totalTeamCapacity = parseFloat(document.getElementById('totalTeamCapacity').innerText);
            const reservedCapacity = parseFloat(document.getElementById('reservedCapacity').value) / 100;

            if (!isNaN(totalTeamCapacity) && totalTeamCapacity > 0) {
                const adjustedCapacity = totalTeamCapacity * (1 - reservedCapacity);
                const targetStoryPoints = Math.round((adjustedCapacity / 100) * teamVelocity);
                document.getElementById('targetStoryPoints').innerText = targetStoryPoints;
            } else {
                document.getElementById('targetStoryPoints').innerText = 0;
            }
        }
    </script>
</body>
</html>